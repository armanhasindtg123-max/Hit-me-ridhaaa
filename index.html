<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Ridha</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-color: #fdf6f6;
            --blob-color: #a2d2ff;
            --blob-shadow: #8bbce8;
            --text-color: #555b6e;
            --accent-pink: #ffafcc;
            --accent-dark: #cdb4db;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #fff, var(--bg-color));
            font-family: 'Quicksand', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }

        /* ========== STAGE CONTAINERS ========== */
        .stage-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 2s ease;
        }

        .stage-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* ========== STAGE 1: CLICK/TAP EXPERIENCE ========== */
        #stage1 {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .counter-container {
            position: absolute;
            top: 10%;
            text-align: center;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .counter-label {
            font-size: 1rem;
            color: #888;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .counter-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-pink);
        }

        .scene {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .avatar {
            width: 180px;
            height: 180px;
            background-color: var(--blob-color);
            border-radius: 50%;
            position: relative;
            box-shadow: 
                inset -10px -10px 20px var(--blob-shadow),
                0 20px 40px rgba(162, 210, 255, 0.4);
            transition: transform 0.1s ease-out, border-radius 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .eyes {
            display: flex;
            gap: 40px;
            margin-bottom: 10px;
        }

        .eye {
            width: 15px;
            height: 15px;
            background: #333;
            border-radius: 50%;
            position: relative;
        }

        .eye::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: -5px;
            width: 25px;
            height: 10px;
            background: rgba(255, 100, 100, 0.1);
            border-radius: 50%;
        }

        .mouth {
            width: 20px;
            height: 10px;
            border-bottom: 3px solid #333;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .squash { animation: squashAnim 0.3s ease-out; }
        
        @keyframes squashAnim {
            0% { transform: scale(1); }
            40% { transform: scale(1.2, 0.7) translateY(10px); }
            60% { transform: scale(0.9, 1.1) translateY(-10px); }
            80% { transform: scale(1.05, 0.95); }
            100% { transform: scale(1); }
        }

        .shake { animation: shakeAnim 0.3s ease-in-out; }
        
        @keyframes shakeAnim {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            50% { transform: translateX(10px) rotate(5deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0); }
        }

        .avatar.dizzy .eye {
            height: 3px;
            width: 15px;
            border-radius: 0;
            transform: rotate(45deg);
        }
        .avatar.dizzy .eye:last-child {
            transform: rotate(-45deg);
        }
        .avatar.dizzy .mouth {
            width: 15px;
            height: 15px;
            border: 3px solid #333;
            border-radius: 50%;
            background: transparent;
        }

        .message-bubble {
            position: absolute;
            pointer-events: none;
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1rem;
            opacity: 0;
            transform: translateY(20px);
            animation: floatUp 2s forwards;
            width: 100%;
            text-align: center;
            top: -60px;
        }

        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(20px) scale(0.8); }
            20% { opacity: 1; transform: translateY(0) scale(1); }
            80% { opacity: 1; transform: translateY(-10px); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        /* ========== STAGE 2: HAND TRACKING ========== */
        #stage2 {
            font-family: 'Fredoka', sans-serif;
        }

        .input_video {
            display: none;
        }

        #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            transform: scaleX(-1);
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
        }

        .hud {
            text-align: center;
            transition: opacity 0.5s;
        }

        .avatar-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .avatar-body {
            width: 160px;
            height: 160px;
            background-color: #a0c4ff;
            border-radius: 50%;
            position: relative;
            box-shadow: 
                inset -10px -10px 20px rgba(0,0,0,0.1),
                0 10px 30px rgba(160, 196, 255, 0.4);
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .face {
            position: relative;
            top: 0px;
            transition: top 0.2s;
        }

        .heart-shield {
            position: absolute;
            width: 220px;
            height: 220px;
            border: 4px solid var(--accent-pink);
            border-radius: 50%;
            opacity: 0.5;
            transform: scale(1);
            transition: all 0.3s;
        }

        .wobble { animation: wobbleAnim 0.4s ease-out; }
        .hit { animation: hitAnim 0.2s ease-in-out; }
        
        @keyframes wobbleAnim {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1, 0.9) translate(-5px, 5px); }
            50% { transform: scale(0.9, 1.1) translate(5px, -5px); }
            75% { transform: scale(1.05, 0.95); }
        }

        @keyframes hitAnim {
            0% { border-color: var(--accent-pink); }
            50% { border-color: #ff6b6b; opacity: 1; }
            100% { border-color: var(--accent-pink); }
        }

        .message {
            position: absolute;
            top: -80px;
            width: 300px;
            text-align: center;
            font-size: 1.2rem;
            color: #4a4e69;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .message.show { opacity: 1; transform: translateY(0); }

        /* ========== OVERLAYS ========== */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 1s;
            text-align: center;
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            color: var(--accent-dark);
            margin-bottom: 20px;
        }

        button {
            background: var(--blob-color);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-size: 1.1rem;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(162, 210, 255, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            pointer-events: auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(162, 210, 255, 0.8);
        }

        button:active {
            transform: translateY(1px);
        }

        .final-text {
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
        }

        .hint {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #aaa;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

    </style>
</head>
<body>

    <!-- ========== STAGE 1: CLICK/TAP EXPERIENCE ========== -->
    <div id="stage1" class="stage-container">
        <div class="overlay" id="intro-screen">
            <h1>Hey Ridha...</h1>
            <button onclick="startStage1()">I need to make it up to you</button>
            <div class="hint">(Make sure your sound is on ðŸ”ˆ)</div>
        </div>

        <div class="counter-container" id="counter-ui">
            <div class="counter-label">Hits I Deserved</div>
            <div class="counter-value" id="hits">0</div>
        </div>

        <div class="scene">
            <div class="avatar" id="arman-avatar">
                <div class="eyes">
                    <div class="eye"></div>
                    <div class="eye"></div>
                </div>
                <div class="mouth"></div>
            </div>
        </div>
        
        <div class="hint" id="game-hint">Tap me</div>

        <div class="overlay hidden" id="transition-screen">
            <div class="final-text">I can take the hits.<br>Now let me show you something deeper.</div>
            <button onclick="transitionToStage2()">I'm ready to understand</button>
        </div>
    </div>

    <!-- ========== STAGE 2: HAND TRACKING EXPERIENCE ========== -->
    <div id="stage2" class="stage-container stage-hidden">
        <video class="input_video"></video>

        <div id="game-container">
            <canvas id="output_canvas"></canvas>

            <div class="avatar-container" id="avatar-container">
                <div class="message" id="float-message"></div>
                <div class="heart-shield" id="shield"></div>
                <div class="avatar-body" id="avatar2">
                    <div class="face">
                        <div class="eyes">
                            <div class="eye"></div>
                            <div class="eye"></div>
                        </div>
                        <div class="mouth" id="mouth2"></div>
                    </div>
                </div>
            </div>

            <div id="ui-layer">
                <div class="hud" id="hud">
                    <div class="counter-label">Feelings I Didn't Understand</div>
                    <div class="counter-value" id="score">0</div>
                </div>
            </div>
        </div>

        <div class="overlay" id="stage2-intro">
            <h1>Now show me your feelings...</h1>
            <p>Point your finger at me.</p>
            <p style="font-size: 0.9rem; color: #999;">(Allow camera access)</p>
            <button onclick="startStage2()">I'm Ready</button>
        </div>

        <div class="overlay hidden" id="overlay-end">
            <div class="final-text">
                Your feelings hit me harder than anything.<br>
                I understand you better now.
            </div>
            <button onclick="finishExperience()">Talk to me when you're ready</button>
        </div>
    </div>

    <script>
        // ========== AUDIO SETUP ==========
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSoftThud() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100 + Math.random() * 50, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function playPopSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400 + Math.random() * 200, audioCtx.currentTime);
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playHitSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }

        // ========== STAGE 1: CLICK/TAP LOGIC ==========
        const messages = [
            "Oof... yeah, fair point.",
            "I deserved that one.",
            "I didn't listen properly, did I?",
            "I'm sorry, Ridha.",
            "I was being stubborn.",
            "I understand now how it hurt.",
            "I promise to do better.",
            "I miss us being okay.",
            "One more for good measure?",
            "Okay, okay, I get it..."
        ];

        const MAX_HITS = 12;
        let hits = 0;
        let isStage1Active = false;
        
        const avatar = document.getElementById('arman-avatar');
        const counterUI = document.getElementById('counter-ui');
        const hitsDisplay = document.getElementById('hits');
        const introScreen = document.getElementById('intro-screen');
        const transitionScreen = document.getElementById('transition-screen');
        const gameHint = document.getElementById('game-hint');
        const scene = document.querySelector('.scene');

        function startStage1() {
            introScreen.classList.add('hidden');
            setTimeout(() => {
                introScreen.style.display = 'none';
                counterUI.style.opacity = 1;
                isStage1Active = true;
            }, 1000);
        }

        function handleInteraction(e) {
            if (!isStage1Active) return;
            if (e.type === 'touchstart') e.preventDefault();

            hits++;
            hitsDisplay.textContent = hits;
            gameHint.style.opacity = 0;

            playSoftThud();
            animateAvatar();
            
            if (hits >= MAX_HITS) {
                endStage1();
            } else {
                if (Math.random() > 0.3 || hits === 1) {
                    showFloatingMessage();
                }
            }
        }

        function animateAvatar() {
            avatar.classList.remove('squash', 'shake', 'dizzy');
            void avatar.offsetWidth;
            const reaction = Math.random() > 0.5 ? 'squash' : 'shake';
            avatar.classList.add(reaction);
            avatar.classList.add('dizzy');
            setTimeout(() => {
                avatar.classList.remove('dizzy');
            }, 600);
        }

        function showFloatingMessage() {
            const msgContainer = document.createElement('div');
            msgContainer.classList.add('message-bubble');
            let msgText = "";
            if (hits === 1) msgText = messages[0];
            else if (hits === Math.floor(MAX_HITS / 2)) msgText = messages[3];
            else {
                const availableMessages = messages.slice(1, messages.length - 1);
                msgText = availableMessages[Math.floor(Math.random() * availableMessages.length)];
            }
            msgContainer.textContent = msgText;
            const randomX = (Math.random() * 40) - 20;
            msgContainer.style.transform = `translate(${randomX}px, 20px)`;
            scene.appendChild(msgContainer);
            setTimeout(() => msgContainer.remove(), 2000);
        }

        function endStage1() {
            isStage1Active = false;
            counterUI.style.opacity = 0;
            setTimeout(() => {
                transitionScreen.classList.remove('hidden');
            }, 1000);
        }

        avatar.addEventListener('mousedown', handleInteraction);
        avatar.addEventListener('touchstart', handleInteraction);

        // ========== STAGE TRANSITION ==========
        function transitionToStage2() {
            const stage1 = document.getElementById('stage1');
            const stage2 = document.getElementById('stage2');
stage1.style.opacity = '0';
            setTimeout(() => {
                stage1.style.display = 'none';
                stage2.classList.remove('stage-hidden');
            }, 2000);
        }

        // ========== STAGE 2: HAND TRACKING LOGIC ==========
        const MAX_SCORE = 50;
        let score = 0;
        let isStage2Active = false;
        let lastShotTime = 0;
        const SHOT_DELAY = 150;
        
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const avatar2 = document.getElementById('avatar2');
        const shield = document.getElementById('shield');
        const scoreDisplay = document.getElementById('score');
        const floatMsg = document.getElementById('float-message');
        const mouth2 = document.getElementById('mouth2');
        const hud = document.getElementById('hud');
        const stage2Intro = document.getElementById('stage2-intro');
        const overlayEnd = document.getElementById('overlay-end');
        
        let bullets = [];
        let particles = [];
        let handPosition = { x: 0, y: 0, visible: false };
        
        const dialogues = [
            { at: 10, text: "Okay... that one hit." },
            { at: 20, text: "I deserved that." },
            { at: 30, text: "I wasn't listening properly." },
            { at: 40, text: "I finally felt what you felt." },
            { at: 48, text: "I'm sorry, Ridha." }
        ];

        function startStage2() {
            stage2Intro.classList.add('hidden');
            isStage2Active = true;
            resizeCanvas();
            initCamera();
            loop();
        }

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function onResults(results) {
            if (!isStage2Active) return;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const indexTip = landmarks[8];
                
                handPosition.x = indexTip.x * canvasElement.width;
                handPosition.y = indexTip.y * canvasElement.height;
                handPosition.visible = true;

                canvasCtx.beginPath();
                canvasCtx.arc(handPosition.x, handPosition.y, 10, 0, 2 * Math.PI);
                canvasCtx.fillStyle = "rgba(255, 183, 178, 0.8)";
                canvasCtx.fill();

                const now = Date.now();
                if (now - lastShotTime > SHOT_DELAY) {
                    spawnBullet(handPosition.x, handPosition.y);
                    lastShotTime = now;
                    playPopSound();
                }
            } else {
                handPosition.visible = false;
            }

            updatePhysics();
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        function initCamera() {
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });
            camera.start();
        }

        function loop() {
            if (isStage2Active) {
                requestAnimationFrame(loop);
            }
        }

        function spawnBullet(x, y) {
            const targetX = canvasElement.width / 2;
            const targetY = canvasElement.height / 2;
            const angle = Math.atan2(targetY - y, targetX - x);
            const speed = 10;

            bullets.push({
                x: x,
                y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                size: 20,
                color: `hsl(${340 + Math.random()*20}, 100%, 80%)`
            });
        }

        function drawHeart(x, y, size, color) {
            canvasCtx.fillStyle = color;
            canvasCtx.beginPath();
            const topCurveHeight = size * 0.3;
            canvasCtx.moveTo(x, y + topCurveHeight);
            canvasCtx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + topCurveHeight);
            canvasCtx.bezierCurveTo(x - size / 2, y + (size + topCurveHeight) / 2, x, y + (size + topCurveHeight) / 2, x, y + size);
            canvasCtx.bezierCurveTo(x, y + (size + topCurveHeight) / 2, x + size / 2, y + (size + topCurveHeight) / 2, x + size / 2, y + topCurveHeight);
            canvasCtx.bezierCurveTo(x + size / 2, y, x, y, x, y + topCurveHeight);
            canvasCtx.fill();
        }

        function updatePhysics() {
            const centerX = canvasElement.width / 2;
            const centerY = canvasElement.height / 2;
            const avatarRadius = 80;

            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx;
                b.y += b.vy;
                drawHeart(b.x, b.y, b.size, b.color);

                const dist = Math.hypot(b.x - centerX, b.y - centerY);
                if (dist < avatarRadius) {
                    handleHit();
                    bullets.splice(i, 1);
                    for(let j=0; j<5; j++) {
                        particles.push({
                            x: b.x,
                            y: b.y,
                            vx: (Math.random() - 0.5) * 5,
                            vy: (Math.random() - 0.5) * 5,
                            life: 1.0
                        });
                    }
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                canvasCtx.globalAlpha = p.life;
                canvasCtx.fillStyle = "#ffb7b2";
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, 3, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.globalAlpha = 1.0;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function handleHit() {
            if (!isStage2Active) return;

            score++;
            scoreDisplay.innerText = score;
            
            avatar2.classList.remove('wobble');
            shield.classList.remove('hit');
            void avatar2.offsetWidth;
            avatar2.classList.add('wobble');
            shield.classList.add('hit');
            playHitSound();

            if(score % 2 === 0) mouth2.style.borderRadius = "20px 20px 0 0";
            else mouth2.style.borderRadius = "0 0 20px 20px";

            let shieldHealth = 1 - (score / MAX_SCORE);
            shield.style.opacity = Math.max(0.1, shieldHealth);

            const dialogue = dialogues.find(d => d.at === score);
            if (dialogue) {
                showStage2Message(dialogue.text);
            }

            if (score >= MAX_SCORE) {
                endStage2();
            }
        }

        function showStage2Message(text) {
            floatMsg.innerText = text;
            floatMsg.classList.add('show');
            setTimeout(() => {
                floatMsg.classList.remove('show');
            }, 3000);
        }

        function endStage2() {
            isStage2Active = false;
            hud.style.opacity = 0;
            setTimeout(() => {
                overlayEnd.classList.remove('hidden');
            }, 2000);
        }

        function finishExperience() {
            const btn = overlayEnd.querySelector('button');
            btn.textContent = "Message sent â™¥";
            btn.style.backgroundColor = "#cdb4db";
            btn.style.pointerEvents = "none";
        }

    </script>
</body>
</html>
 